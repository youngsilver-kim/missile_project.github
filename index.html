<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>전주대학교 3D 지도 + 미사일 시뮬레이션</title>
  <style>
    body { margin:0; padding:0; background:linear-gradient(135deg,#667eea,#764ba2); font-family:Arial,sans-serif; overflow:hidden; }
    #container { position:relative; width:100vw; height:100vh; }
    #loading { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-size:1.2em; z-index:10; }
    #info-panel { position:absolute; top:20px; left:20px; width:280px; padding:15px; background:rgba(255,255,255,0.9); border-radius:12px; }
    #controls   { position:absolute; top:20px; right:20px; width:200px; padding:15px; background:rgba(255,255,255,0.9); border-radius:12px; }
    .control-group { margin-bottom:10px; }
    .control-group label { font-weight:bold; display:block; margin-bottom:4px; }
    .control-group input { width:100%; }
    #terrain    { position:absolute; bottom:0; left:0; width:100%; height:60%; }
    #missile-sim{ position:absolute; top:0; right:0; width:50vw; height:50vh; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
</head>
<body>
  <div id="container">
    <div id="loading">3D 지도를 로딩 중...</div>
    <div id="info-panel">
      <h2>전주대학교 3D 지도</h2>
      <p>위도: 35.8242° N<br>경도: 127.1480° E<br>고도: 약 50 m<br>주소: 전북 전주시 완산구 천잠로 303</p>
    </div>
    <div id="controls">
      <div class="control-group">
        <label for="rotation-speed">회전 속도</label>
        <input type="range" id="rotation-speed" min="0" max="2" step="0.1" value="0.5">
      </div>
      <div class="control-group">
        <label for="zoom-level">줌 레벨</label>
        <input type="range" id="zoom-level" min="0.5" max="2" step="0.1" value="1">
      </div>
      <div class="control-group">
        <label for="tilt-angle">기울기</label>
        <input type="range" id="tilt-angle" min="30" max="80" step="5" value="60">
      </div>
    </div>
    <div id="terrain"></div>
    <div id="missile-sim"></div>
  </div>

  <script>
    // 1) 간단한 3D 지형 클래스 정의
    class JeonjuUniversity3D {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        const W = this.container.clientWidth, H = this.container.clientHeight;
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(45, W/H, 1, 1000);
        this.camera.position.set(0, 80, 200);
        this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        this.renderer.setSize(W, H);
        this.container.appendChild(this.renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(100, 200, 100);
        this.scene.add(light);

        // 랜덤 높이의 평면 지형
        const geom = new THREE.PlaneGeometry(400, 400, 80, 80);
        geom.rotateX(-Math.PI/2);
        const pos = geom.attributes.position;
        for (let i=0; i<pos.count; i++) {
          pos.setY(i, Math.random()*10);
        }
        geom.computeVertexNormals();
        const mat = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
        this.scene.add(new THREE.Mesh(geom, mat));

        // 컨트롤 기본값
        this.rotationSpeed = parseFloat(document.getElementById('rotation-speed').value);
        this.camera.zoom    = parseFloat(document.getElementById('zoom-level').value);
        this.camera.updateProjectionMatrix();
        this.camera.rotation.x = parseInt(document.getElementById('tilt-angle').value) * Math.PI/180;

        this.animate();
      }
      animate() {
        requestAnimationFrame(() => this.animate());
        this.scene.rotation.y += this.rotationSpeed * 0.005;
        this.renderer.render(this.scene, this.camera);
      }
    }

    // 2) 미사일 시뮬레이션 클래스 (기존 코드 유지)
    class MissileSimulation {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        const W = this.container.clientWidth, H = this.container.clientHeight;
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(45, W/H, 1, 1000);
        this.camera.position.set(100,100,200);
        this.renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
        this.renderer.setSize(W,H);
        this.container.appendChild(this.renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff,1);
        light.position.set(50,100,100);
        this.scene.add(light);

        // 기지 A
        const base = new THREE.Mesh(
          new THREE.SphereGeometry(3,16,16),
          new THREE.MeshStandardMaterial({ color:0x0000ff })
        );
        base.position.set(50,20,0);
        this.scene.add(base);

        // 궤적 계산
        this.computeTrajectories();
        this.animate();
      }

      computeTrajectories() {
        const vI = 120;
        const SA = new THREE.Vector3(50,20,0);
        const PH1 = t => new THREE.Vector3(250-20*t,300-25*t,400-4.9*t*t);

        let tImpact=0, minErr=Infinity;
        const groundT = Math.sqrt(400/4.9);
        for(let t=0; t<=groundT; t+=0.01) {
          const err = PH1(t).distanceTo(SA) - vI*t;
          if (Math.abs(err)<minErr) { minErr = Math.abs(err); tImpact = t; }
        }

        const Pimp = PH1(tImpact);
        const u    = Pimp.clone().sub(SA).normalize();

        this.enemyPoints = []; this.intPoints = [];
        const steps = 200;
        for (let i=0; i<=steps; i++) {
          const tt = tImpact * i/steps;
          this.enemyPoints.push(PH1(tt));
          this.intPoints.push(SA.clone().add(u.clone().multiplyScalar(vI*tt)));
        }

        this.scene.add(
          new THREE.Line(
            new THREE.BufferGeometry().setFromPoints(this.enemyPoints),
            new THREE.LineBasicMaterial({ color:0xff6600 })
          ),
          new THREE.Line(
            new THREE.BufferGeometry().setFromPoints(this.intPoints),
            new THREE.LineBasicMaterial({ color:0x00ffff })
          )
        );

        const dotGeom = new THREE.SphereGeometry(2,8,8);
        this.enemyDot = new THREE.Mesh(dotGeom, new THREE.MeshStandardMaterial({ color:0xff0000 }));
        this.intDot   = new THREE.Mesh(dotGeom, new THREE.MeshStandardMaterial({ color:0x0000ff }));
        this.scene.add(this.enemyDot, this.intDot);

        this.frame = 0; this.maxFrame = steps;
      }

      animate() {
        requestAnimationFrame(() => this.animate());
        this.scene.rotation.y += 0.002;
        if (this.frame < this.maxFrame) {
          this.enemyDot.position.copy(this.enemyPoints[this.frame]);
          this.intDot.position.copy(this.intPoints[this.frame]);
          this.frame++;
        }
        this.renderer.render(this.scene, this.camera);
      }
    }

    // 3) 초기화
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => document.getElementById('loading').style.display = 'none', 2000);
      const map3d      = new JeonjuUniversity3D('terrain');
      const missileSim = new MissileSimulation('missile-sim');

      // 컨트롤 연결
      document.getElementById('rotation-speed').addEventListener('input', e => {
        map3d.rotationSpeed = parseFloat(e.target.value);
      });
      document.getElementById('zoom-level').addEventListener('input', e => {
        map3d.camera.zoom = parseFloat(e.target.value);
        map3d.camera.updateProjectionMatrix();
      });
      document.getElementById('tilt-angle').addEventListener('input', e => {
        map3d.camera.rotation.x = parseInt(e.target.value) * Math.PI/180;
      });
    });
  </script>
</body>
</html>
